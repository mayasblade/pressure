<html>
<head>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<title>Stay in Place</title>
</head>
<body>
	<div class="container-fluid">

			<div class="display" id="on">On: 0</div>
			<div class="display" id="off">Off: 0</div>

			<div class="text-center">
				<button class="btn btn-warning" id="press">Press</button>
			</div>

		<form class="form-group">
			<label>
				Ramp Interval:
				<input name="rampInterval" type="number" value="5" step="1" />
			</label>

			<label>
				Minutes:
				<input name="minutes" type="number" value="5" step="1" />
			</label>

			<label>
				Callback URL:
				<input name="callBackUrl" type="text" />
			</label>
		</form>


		<h2>Toys (Lovense Connect)</h2>
		<div class="btn-group" id="toyList">
			
		</div>

		<div class="container">
			<p>
				"Stay In Place" v0.5 (c) 2018 mayaloux.com 
			</p>
			<a href="about.html">About</a>

		</div>


	</div>

<style>

.display {
	min-width: 300px;
	font-size: 5em;
}

#press {
	width: 800px;
	height: 800px;
	
	margin: auto;

	border-radius: 100%;

	font-size: 4em;
}

#off {
	color: red;
}

</style>


<script>

	var targetTime = false;

	var isPressed = false;

	var startTime = new Date().getTime() / 1000;

	var started = false;

	var secondsOff = 0;

	var secondsOn = 0;

	var secondsSinceLastOff = 0;

	var rampInterval = 5;

	var callBackUrl = false;


	function doCallBack(callBackUrl, data)
	{
	
		$.ajax({
		    type : "post",
		    url : callBackUrl,
		    dataType : "jsonp",
		    data: data,
		    success : function(data){
		        console.error(e);
		    },
		    error:function(e){
		        console.error(e);
		    }
		});
		
	}


	$(document).ready(function () {
		$('#press').bind("mousedown touchstart", function (e) {
			isPressed = true;

			if (started == false) {
				started = true;
			}
		});

		$('#press').bind("mouseup touchend", function (e) {
			isPressed = false;
		});

		// Query lovense LAN API for any local toys connected
		getToys();

		/**
		 * MAIN LOOP
		 *
		 * Checks every .5 seconds if the user is still pressing the button
		 * 	- Original timing was .25, but on Galaxy S6 this was too sensitive
		 *
		 * 
		 */
		var interval = setInterval(function () {

			var currentTime = new Date().getTime() / 1000;

			if ( $('input[name="callBackUrl"]').val().length > 0) {
				callBackUrl = $('input[name="callBackUrl"]').val();
			}

			if (started && targetTime == false)
			{
				var minutes = $('input[name="minutes"]').val();

				targetTime = startTime + (minutes * 60);
			}

			if (started && targetTime !== false && currentTime >= targetTime) {
				clearInterval(interval);
			}

			if (started && isPressed === false) {
				secondsOff += .5;

				$('#off').text( "Off:" + Math.floor(secondsOff) );

				runToys("stop");

				secondsSinceLastOff = 0;
			}

			if (started && isPressed) {
				secondsOn += .5;

				secondsSinceLastOff += .5;

				$('#on').text( "On:" + Math.floor(secondsOn) );

				var level = Math.floor(secondsSinceLastOff / rampInterval);

				runToys(level);
			}

			if (callBackUrl !== false) {
				doCallBack(callBackUrl, {
					"isPressed": isPressed,
					"startTime": startTime,
					"targetTime": targetTime,
					"secondsOn": secondsOn,
					"secondsOff": secondsOff,
					"secondsSinceLastOff": secondsSinceLastOff
				});
			}

		}, 500);
		

	});


	/**
	 * Send command and value to the lovense API
	 * See the LAN API here: https://www.lovense.com/developer/docs/lanlevel
	 *
	 * @param string target 	Protocol, url, and port for the toy
	 * @param string command 	Command to send the toy(s)
	 * @param int v 			Vibration level for toy, 0-20
	*/
	function sendCommand(target, command, v) {
		$.ajax({
		    type : "get",
		    url : target + "/" + command + "?v=" + v,
		    dataType : "jsonp",
		    success : function(data){
		        
		    },
		    error:function(e){
		        console.error(e);
		    }
		});
	}

	/**
	 * Makes the toy buttons toggles that turn the toy on or off
	 *
	 */
	function parseToys(toy)
	{

		if ($(toy).hasClass("active")) {

			$(toy).removeClass("active");

			stopToy(toy);

		} else {
			$(toy).addClass("active");
		}
	}

	/**
	 * Takes a link element from the #toyList and sets the level to 0
	 *
	 *
	*/
	function stopToy(toy) {
		var url = $(toy).attr("x-toy-url");

		sendCommand(url, "Vibrate", 0);
	}

	/**
	 * Sets all active toys to the given level (range 0-20)
	 * Special values:
	 *
	 * max - set to 20
	 * stop - stop all toys
	*/
	function runToys(adjust)
	{

		$.each( $('#toyList a.active'), function(i, value) {
			
			var url = $(value).attr("x-toy-url");
			var level = parseInt($(value).attr("x-toy-level"));
			

			if (adjust == 'stop') {
				level = 0;	
			} else if (adjust == 'max') {
				level = 20;
			} else {
				level = adjust;
			}

			

			if (level > 20) {
				level = 20;
			}

			$(value).attr("x-toy-level", level);

			sendCommand(url, "Vibrate", level);

		});
	}


	/**
	 * Populate the list of available toys
	 *
	*/
	function getToys() {
		$.ajax({
		    type : "get",
		    url : "https://api.lovense.com/api/lan/getToys",
		    dataType : "jsonp",
		    success : function(data){
		        
		    	data = JSON.parse(data);

		    	for (var key in data) {
		    		var domain = data[key].domain;
		    		var port = data[key].httpPort;

		    		var baseUrl = 'http://' + domain + ":" + port;

		    		$('#toyList').append("<a onClick='parseToys(this);' class='btn btn-default toyButton' x-toy-url='" 
		    			+ baseUrl + "' x-toy-level='0'>" + domain+ "</a>");
		    	}



		    },
		    error:function(e){
		        console.error(e);
		    }
		});
	}

</script>

</body>
</html>